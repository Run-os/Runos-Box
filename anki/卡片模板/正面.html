<!-- 1. 强制夜间模式检测 -->
<script>
    (function () {
        var body = document.body;
        var isNight = body.classList.contains("night") || body.classList.contains("nightMode") || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isNight) { document.documentElement.classList.add("night"); document.body.classList.add("night"); }
    })();
</script>

<!-- 2. 隐藏原始数据 -->
<div id="raw-Front" style="display:none">{{Front}}</div>

<!-- 3. 卡片容器 -->
<div class="minimal-card">
    <span class="label">Question</span>
    <div id="render-Front" class="content-block question-text"></div>
</div>

<!-- 4. 核心渲染脚本 -->
<script>
    var getResources = [
        getCSS("_katex.css", "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"),
        getCSS("_highlight.css", "https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css"),
        getScript("_highlight.js", "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"),
        getScript("_katex.min.js", "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"),
        getScript("_auto-render.js", "https://cdn.jsdelivr.net/gh/Jwrede/Anki-KaTeX-Markdown/auto-render-cdn.js"),
        getScript("_markdown-it.min.js", "https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"),
        // markdown-it 官方独立插件
        getScript("_markdown-it-mark.min.js", "https://cdn.jsdelivr.net/npm/markdown-it-mark@3.0.1/dist/markdown-it-mark.min.js"),
    ];

    Promise.all(getResources)
        .then(() => getScript("_mhchem.js", "https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/mhchem.min.js"))
        .then(render)
        .catch(e => { console.error(e); fallback() });

    function render() {
        processField("raw-Front", "render-Front");
    }

    function fallback() {
        document.getElementById("render-Front").innerHTML = document.getElementById("raw-Front").innerHTML;
    }

    function processField(sourceID, targetID) {
        let text = document.getElementById(sourceID).innerHTML;
        text = cleanAnkiHTML(text);
        // 处理bullet点为标准markdown列表
        text = processBulletsInText(text);

        let md = new markdownit({
            html: true,
            breaks: true,
            highlight: function (str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try { return hljs.highlight(str, { language: lang }).value; } catch (__) { }
                }
                return '';
            }
        });

        // 使用 markdown-it-mark 插件 (==text== 高亮)
        if (typeof markdownitMark !== 'undefined') {
            md.use(markdownitMark);
            console.log('[Debug] markdown-it-mark loaded');
        }

        let rendered = md.render(text);
        let target = document.getElementById(targetID);
        target.innerHTML = rendered;

        renderMathInElement(target, {
            delimiters: [{ left: "$$", right: "$$", display: true }, { left: "$", right: "$", display: false }],
            throwOnError: false
        });
    }

    // 处理bullet点（•/-）- 转换为标准Markdown无序列表
    function processBulletsInText(text) {
        return text.replace(/^[•-]\s+(.+)$/gm, (match, content) => {
            return '- ' + content.trim();
        });
    }

    function cleanAnkiHTML(str) {
        str = str.replace(/<[\/]?pre[^>]*>/gi, "");
        str = str.replace(/<br\s*[\/]?[^>]*>/gi, "\n");
        str = str.replace(/<div[^>]*>/gi, "\n");
        str = str.replace(/<[\/]?span[^>]*>/gi, "");
        str = str.replace(/<\/div[^>]*>/g, "\n");
        // 【修复】正确的实体解码顺序：先解码完整的实体，再解码单个字符
        // 解码完整的 HTML 实体（这些实体不会与普通字符混淆）
        str = str.replace(/&nbsp;/gi, " ");
        str = str.replace(/&tab;/gi, "	");
        str = str.replace(/&/gi, "&");      // & 实体必须最先解码
        str = str.replace(/</gi, "<");       // < 实体
        str = str.replace(/>/gi, ">");       // > 实体
        str = str.replace(/"/gi, '"');     // " 实体
        str = str.replace(/'/gi, "'");      // ' 实体
        return str;
    }

    function getScript(path, altURL) {
        return new Promise((resolve, reject) => {
            if (window[path]) return resolve();
            let script = document.createElement("script");
            script.onload = () => { window[path] = true; resolve(); };
            script.onerror = () => {
                let script_online = document.createElement("script");
                script_online.onload = () => { window[path] = true; resolve(); };
                script_online.onerror = resolve;
                script_online.src = altURL;
                document.head.appendChild(script_online);
            }
            script.src = path;
            document.head.appendChild(script);
        })
    }

    function getCSS(path, altURL) {
        return new Promise((resolve, reject) => {
            let css = document.createElement('link');
            css.rel = 'stylesheet';
            css.onload = resolve;
            css.onerror = () => {
                let css_online = document.createElement('link');
                css_online.rel = 'stylesheet';
                css_online.href = altURL;
                document.head.appendChild(css_online);
                resolve();
            }
            css.href = path;
            document.head.appendChild(css);
        });
    }
</script>